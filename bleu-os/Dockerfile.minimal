# Bleu OS Docker Image - Minimal Version
# Lightweight version with only essential components

FROM alpine:3.23

ARG BLEU_OS_VERSION=1.0.0

LABEL maintainer="HelloblueAI <support@helloblue.ai>"
LABEL description="Bleu OS - Minimal Quantum-Enhanced AI Operating System"
LABEL version="${BLEU_OS_VERSION}"
LABEL org.opencontainers.image.source="https://github.com/HelloblueAI/Bleu.js"
LABEL org.opencontainers.image.licenses="MIT"
LABEL org.opencontainers.image.base.name="alpine:3.23"
LABEL security.scanning="enabled"
LABEL security.hardening="enabled"

# Install minimal dependencies; apk upgrade pulls expat>=2.7.4-r0 (CVE-2026-25210, CVE-2026-24515)
RUN apk update && \
    apk upgrade --no-cache --available && \
    apk add --no-cache \
    ca-certificates \
    bash \
    python3 \
    py3-pip \
    && rm -rf /var/cache/apk/* \
    && update-ca-certificates

# Upgrade pip/setuptools and fix PyPI CVEs: urllib3 (CVE-2026-21441), wheel (CVE-2026-24049)
RUN pip3 install --no-cache-dir --break-system-packages --upgrade \
    pip>=25.3 \
    setuptools>=78.1.1 \
    "urllib3>=2.6.3" \
    "wheel>=0.46.3"

# Create non-root user
RUN addgroup -g 1000 bleuos && \
    adduser -D -u 1000 -G bleuos bleuos

# Set environment
ENV PYTHONUNBUFFERED=1 \
    BLEU_OS_VERSION=${BLEU_OS_VERSION} \
    PATH="/home/bleuos/.local/bin:$PATH"

# Install Bleu.js from repo so dependency tree uses local pyproject.toml (no python-jose/ecdsa)
# PyPI-published bleu-js still lists python-jose -> ecdsa (CVE-2024-23342); local install avoids it
USER bleuos
WORKDIR /home/bleuos

RUN pip3 install --user --no-cache-dir --break-system-packages --upgrade \
    pip \
    setuptools \
    wheel

# Copy only what's needed to install bleu-js from repo (no ecdsa)
COPY --chown=bleuos:bleuos pyproject.toml setup.py README.md /opt/bleu-js/
COPY --chown=bleuos:bleuos src/bleujs /opt/bleu-js/src/bleujs

RUN pip3 install --user --no-cache-dir --break-system-packages \
    "cryptography>=46.0.5" \
    "numpy>=2.2.6" && \
    pip3 install --user --no-cache-dir --break-system-packages -e /opt/bleu-js

# System config
USER root
COPY --chown=root:root bleu-os/config/bleu-optimizations.conf /etc/bleu-os/
COPY --chown=root:root bleu-os/scripts/init-bleu-os.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/init-bleu-os.sh

RUN mkdir -p /workspace && chown -R bleuos:bleuos /workspace

USER bleuos
WORKDIR /workspace

ENTRYPOINT ["/usr/local/bin/init-bleu-os.sh"]
CMD ["bash"]
