name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly dependency check

env:
  AWS_REGION: us-east-1
  PYTHON_VERSION: '3.10'
  POETRY_VERSION: '1.7.1'
  CACHE_VERSION: 'v1'

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: kentaro-m/auto-assign-action@v1.2.0
        with:
          configuration-path: .github/auto-assign.yml

  version-bump:
    needs: auto-assign
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Bump version and push tag
        uses: anothrNick/github-tag-action@1.64.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WITH_V: true
          DEFAULT_BUMP: patch
          RELEASE_BRANCHES: main

  test:
    needs: [auto-assign, version-bump]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: [3.10, 3.11]
        include:
          - python-version: 3.10
            qiskit-version: '1.1.0'
            qiskit-aer-version: '0.13.0'
          - python-version: 3.11
            qiskit-version: '1.1.0'
            qiskit-aer-version: '0.13.0'

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Cache Poetry virtualenv
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/poetry.lock') }}

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: pip-${{ runner.os }}-${{ matrix.python-version }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/poetry.lock') }}

    - name: Install Poetry
      run: |
        python -m pip install --upgrade pip
        pip install poetry==${{ env.POETRY_VERSION }}

    - name: Configure Poetry
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
        poetry config installer.max-workers 4

    - name: Install dependencies
      run: |
        poetry install --no-interaction --no-root --with dev
        poetry run pip install "qiskit==${{ matrix.qiskit-version }}"
        poetry run pip install "qiskit-aer==${{ matrix.qiskit-aer-version }}"

    - name: Verify dependency versions
      run: |
        poetry run pip check
        poetry run pip freeze | grep -E "black|qiskit|fastapi|starlette"
        poetry run pip show black qiskit fastapi starlette

    - name: Run tests with coverage
      run: |
        poetry run pytest --cov=./ --cov-report=xml src/python/ml/computer_vision/test_quantum_fusion.py
        poetry run pytest --cov=./ --cov-report=xml src/python/ml/quantum_ml/test_quantum_ml.py
        poetry run pytest --cov=./ --cov-report=xml src/python/ml/quantum_ml/test_quantum_ml_utils.py

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.xml
        fail_ci_if_error: true
        verbose: true

    - name: Upload coverage reports
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: ./coverage.xml

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.python-version }}
        path: |
          coverage.xml
          .coverage
          **/test-results/
        retention-days: 7

    - name: Notify Slack on Test Failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "attachments": [{
              "color": "danger",
              "title": "Tests Failed üö®",
              "text": "Tests failed for Python ${{ matrix.python-version }} on ${{ matrix.os }}\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}",
              "fields": [
                {
                  "title": "Repository",
                  "value": "${{ github.repository }}",
                  "short": true
                },
                {
                  "title": "Branch",
                  "value": "${{ github.ref }}",
                  "short": true
                },
                {
                  "title": "Test Coverage",
                  "value": "${{ steps.coverage.outputs.coverage }}%",
                  "short": true
                }
              ]
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  lint:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Cache Poetry virtualenv
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-lint-${{ hashFiles('**/poetry.lock') }}

    - name: Install Poetry
      run: |
        python -m pip install --upgrade pip
        pip install poetry==${{ env.POETRY_VERSION }}

    - name: Configure Poetry
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true

    - name: Install dependencies
      run: poetry install --no-interaction --no-root

    - name: Run linting tools
      run: |
        poetry run black . --check
        poetry run isort . --check-only
        poetry run flake8 .
        poetry run mypy .
        poetry run bandit -r .

    - name: Notify Slack on Lint Failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "attachments": [{
              "color": "warning",
              "title": "Code Quality Check Failed ‚ö†Ô∏è",
              "text": "Linting or code quality checks failed\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}",
              "fields": [
                {
                  "title": "Repository",
                  "value": "${{ github.repository }}",
                  "short": true
                },
                {
                  "title": "Branch",
                  "value": "${{ github.ref }}",
                  "short": true
                }
              ]
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  security:
    needs: lint
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Cache Poetry virtualenv
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-security-${{ env.CACHE_VERSION }}-${{ hashFiles('**/poetry.lock') }}

    - name: Install Poetry
      run: |
        python -m pip install --upgrade pip
        pip install poetry==${{ env.POETRY_VERSION }}

    - name: Configure Poetry
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true

    - name: Install dependencies
      run: poetry install --no-interaction --no-root --with dev

    - name: Run Snyk to check for vulnerabilities
      run: |
        npm install -g snyk
        snyk auth ${{ secrets.SNYK_TOKEN }}
        snyk test --severity-threshold=high --json-file-output=snyk-results.json || true
      continue-on-error: true

    - name: Run dependency check
      run: |
        poetry run pip install safety
        poetry run safety check --full-report --output-file safety-report.json

    - name: Run bandit security scan
      run: |
        poetry run bandit -r . -ll -f json -o bandit-results.json

    - name: Run trivy for container scanning
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Run pip-audit for Python dependencies
      run: |
        poetry run pip install pip-audit
        poetry run pip-audit --format json --output pip-audit-results.json

    - name: Upload security reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          snyk-results.json
          safety-report.json
          bandit-results.json
          trivy-results.sarif
          pip-audit-results.json
        retention-days: 7

    - name: Notify Slack on Security Issues
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "attachments": [{
              "color": "danger",
              "title": "Security Check Failed üîí",
              "text": "Security vulnerabilities detected\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}",
              "fields": [
                {
                  "title": "Repository",
                  "value": "${{ github.repository }}",
                  "short": true
                },
                {
                  "title": "Branch",
                  "value": "${{ github.ref }}",
                  "short": true
                },
                {
                  "title": "Critical Issues",
                  "value": "${{ steps.security.outputs.critical_issues }}",
                  "short": true
                },
                {
                  "title": "High Issues",
                  "value": "${{ steps.security.outputs.high_issues }}",
                  "short": true
                }
              ]
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  check-dependencies:
    needs: security
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install Poetry
      run: |
        python -m pip install --upgrade pip
        pip install poetry==${{ env.POETRY_VERSION }}

    - name: Check for outdated dependencies
      run: |
        poetry self update
        poetry show --outdated

    - name: Create Pull Request if updates available
      uses: peter-evans/create-pull-request@v4
      if: failure()
      with:
        title: 'Update Dependencies'
        body: 'Automated dependency updates'
        branch: 'deps/update-$(date +%Y%m%d)'
        commit-message: 'Update dependencies'
        author: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
        committer: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
        labels: dependencies

  deploy:
    needs: [test, lint, security]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
    - uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2

    - name: Deploy to AWS
      id: deploy
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        set -e
        # Create deployment backup
        aws cloudformation get-template --stack-name bleujs-infrastructure --output text > infrastructure-backup.yml
        aws cloudformation get-template --stack-name bleujs-subscriptions --output text > subscriptions-backup.yml
        aws cloudformation get-template --stack-name bleujs-lambda --output text > lambda-backup.yml

        # Deploy infrastructure
        aws cloudformation deploy \
          --template-file deploy/aws/infrastructure.yml \
          --stack-name bleujs-infrastructure \
          --capabilities CAPABILITY_IAM \
          --no-fail-on-empty-changeset || { echo "Infrastructure deployment failed"; exit 1; }

        # Deploy API
        aws cloudformation deploy \
          --template-file deploy/aws/subscriptions.yml \
          --stack-name bleujs-subscriptions \
          --capabilities CAPABILITY_IAM \
          --no-fail-on-empty-changeset || { echo "API deployment failed"; exit 1; }

        # Deploy Lambda
        aws cloudformation deploy \
          --template-file deploy/aws/subscription_lambda.yml \
          --stack-name bleujs-lambda \
          --capabilities CAPABILITY_IAM \
          --no-fail-on-empty-changeset || { echo "Lambda deployment failed"; exit 1; }

    - name: Verify deployments
      run: |
        set -e
        # Check infrastructure stack
        aws cloudformation describe-stacks --stack-name bleujs-infrastructure --query 'Stacks[0].StackStatus' | grep -q "CREATE_COMPLETE\|UPDATE_COMPLETE" || { echo "Infrastructure stack not in expected state"; exit 1; }

        # Check subscriptions stack
        aws cloudformation describe-stacks --stack-name bleujs-subscriptions --query 'Stacks[0].StackStatus' | grep -q "CREATE_COMPLETE\|UPDATE_COMPLETE" || { echo "Subscriptions stack not in expected state"; exit 1; }

        # Check lambda stack
        aws cloudformation describe-stacks --stack-name bleujs-lambda --query 'Stacks[0].StackStatus' | grep -q "CREATE_COMPLETE\|UPDATE_COMPLETE" || { echo "Lambda stack not in expected state"; exit 1; }

    - name: Rollback on failure
      if: failure()
      run: |
        set -e
        echo "Rolling back deployments..."

        # Rollback infrastructure
        aws cloudformation deploy \
          --template-file infrastructure-backup.yml \
          --stack-name bleujs-infrastructure \
          --capabilities CAPABILITY_IAM \
          --no-fail-on-empty-changeset || echo "Infrastructure rollback failed"

        # Rollback API
        aws cloudformation deploy \
          --template-file subscriptions-backup.yml \
          --stack-name bleujs-subscriptions \
          --capabilities CAPABILITY_IAM \
          --no-fail-on-empty-changeset || echo "API rollback failed"

        # Rollback Lambda
        aws cloudformation deploy \
          --template-file lambda-backup.yml \
          --stack-name bleujs-lambda \
          --capabilities CAPABILITY_IAM \
          --no-fail-on-empty-changeset || echo "Lambda rollback failed"

    - name: Notify Slack on Deployment Status
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: custom
        custom_payload: |
          {
            "attachments": [{
              "color": "${{ job.status == 'success' && 'good' || 'danger' }}",
              "title": "${{ job.status == 'success' && '‚úÖ Deployment Successful' || '‚ùå Deployment Failed' }}",
              "text": "Deployment to AWS ${{ job.status == 'success' && 'completed successfully' || 'failed' }}\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}",
              "fields": [
                {
                  "title": "Repository",
                  "value": "${{ github.repository }}",
                  "short": true
                },
                {
                  "title": "Branch",
                  "value": "${{ github.ref }}",
                  "short": true
                },
                {
                  "title": "Environment",
                  "value": "Production",
                  "short": true
                },
                {
                  "title": "Deployment Time",
                  "value": "${{ steps.deploy.outputs.deployment_time }}",
                  "short": true
                }
              ]
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Security scan
      uses: github/codeql-action/init@v2
      with:
        languages: python
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
